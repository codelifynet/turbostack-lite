
FROM oven/bun:1 AS base
WORKDIR /app

FROM oven/bun:1.3.6

# Install dependencies - optimized layer caching
FROM base AS deps
# Copy dependency files first (changes less frequently)
COPY package.json bun.lock turbo.json ./
COPY apps/web/package.json ./apps/web/
# API package.json needed because web's tsconfig references @api/* path alias
COPY apps/api/package.json ./apps/api/
# Copy only package.json files from packages (for dependency resolution)
COPY packages/*/package.json ./packages/
# Copy packages directory structure
COPY packages/ ./packages/

# Install with better retry and network handling
RUN bun install --frozen-lockfile 2>&1 || \
    (echo "First attempt failed, retrying..." && \
     bun install --retry 5 2>&1) || \
    (echo "Installing without frozen lockfile..." && \
     bun install --retry 5 2>&1)

# Build stage
FROM base AS builder
COPY --from=deps /app/node_modules ./node_modules
COPY --from=deps /app/packages ./packages
# Copy only necessary files for build
COPY package.json bun.lock turbo.json ./
COPY apps/web/ ./apps/web/
COPY apps/api/ ./apps/api/
COPY packages/ ./packages/

# Set environment for build
ENV NEXT_TELEMETRY_DISABLED=1
ENV NODE_ENV=production

# Generate Prisma client (only if schema changed)
RUN bun run db:generate
# Build Next.js application
RUN cd apps/web && bun run build

# Production stage - minimal runtime image
FROM oven/bun:1 AS runner
WORKDIR /app

ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
ENV PORT=4100
ENV HOSTNAME="0.0.0.0"

# Copy standalone output from builder
COPY --from=builder /app/apps/web/.next/standalone ./
COPY --from=builder /app/apps/web/.next/static ./apps/web/.next/static
COPY --from=builder /app/apps/web/public ./apps/web/public

EXPOSE 4100

# Run the standalone server
CMD ["bun", "run", "apps/web/server.js"]