---
title: Database Schema
description: Prisma database models and relationships
---

# Database Schema

TurboStack uses **Prisma ORM** with PostgreSQL for type-safe database operations.

<Frame caption="Entity Relationship Diagram">
```mermaid
erDiagram
    User ||--o{ Session : has
    User ||--o{ VerificationToken : has
    User ||--o{ PasswordResetToken : has
    User ||--o{ Purchase : makes
    User ||--o{ Subscription : has

    User {
        string id PK
        string email UK
        string name
        string password
        enum role
        datetime emailVerified
        string avatar
        datetime createdAt
        datetime updatedAt
    }

    Session {
        string id PK
        string token UK
        string userId FK
        datetime expiresAt
        datetime createdAt
    }

    VerificationToken {
        string id PK
        string token UK
        string userId FK
        datetime expiresAt
    }

    PasswordResetToken {
        string id PK
        string token UK
        string email
        datetime expiresAt
    }

    Purchase {
        string id PK
        string userId FK
        string productId
        string polarOrderId
        int amount
        string currency
        datetime createdAt
    }

    Subscription {
        string id PK
        string userId FK
        string polarSubscriptionId UK
        string status
        string planId
        datetime currentPeriodEnd
        datetime canceledAt
    }

````
</Frame>

---

## Models

<AccordionGroup>
  <Accordion title="User" icon="user" defaultOpen>
    The main user model with authentication fields.

    ```prisma
    model User {
      id            String    @id @default(cuid())
      email         String    @unique
      name          String?
      password      String
      role          Role      @default(USER)
      emailVerified DateTime?
      avatar        String?
      createdAt     DateTime  @default(now())
      updatedAt     DateTime  @updatedAt

      // Relations
      sessions              Session[]
      verificationTokens    VerificationToken[]
      passwordResetTokens   PasswordResetToken[]
      purchases             Purchase[]
      subscriptions         Subscription[]
    }

    enum Role {
      USER
      ADMIN
    }
    ```

    | Field           | Type      | Description                |
    | --------------- | --------- | -------------------------- |
    | `id`            | String    | CUID primary key           |
    | `email`         | String    | Unique email address       |
    | `password`      | String    | Argon2 hashed password     |
    | `role`          | Enum      | USER or ADMIN              |
    | `emailVerified` | DateTime? | When email was verified    |
  </Accordion>

  <Accordion title="Session" icon="id-card">
    Active user sessions for authentication.

    ```prisma
    model Session {
      id        String   @id @default(cuid())
      token     String   @unique
      userId    String
      expiresAt DateTime
      createdAt DateTime @default(now())

      user User @relation(fields: [userId], references: [id], onDelete: Cascade)

      @@index([userId])
      @@index([token])
    }
    ```
  </Accordion>

  <Accordion title="VerificationToken" icon="envelope-circle-check">
    Email verification tokens sent to users.

    ```prisma
    model VerificationToken {
      id        String   @id @default(cuid())
      token     String   @unique
      userId    String
      expiresAt DateTime
      createdAt DateTime @default(now())

      user User @relation(fields: [userId], references: [id], onDelete: Cascade)

      @@index([token])
      @@index([userId])
    }
    ```
  </Accordion>

  <Accordion title="Purchase" icon="credit-card">
    One-time purchases via Polar.sh.

    ```prisma
    model Purchase {
      id           String   @id @default(cuid())
      userId       String
      productId    String
      polarOrderId String   @unique
      amount       Int
      currency     String   @default("USD")
      createdAt    DateTime @default(now())

      user User @relation(fields: [userId], references: [id], onDelete: Cascade)

      @@index([userId])
      @@index([polarOrderId])
    }
    ```
  </Accordion>

  <Accordion title="Subscription" icon="rotate">
    Recurring subscriptions via Polar.sh.

    ```prisma
    model Subscription {
      id                  String    @id @default(cuid())
      userId              String
      polarSubscriptionId String    @unique
      status              String
      planId              String
      currentPeriodEnd    DateTime
      canceledAt          DateTime?
      createdAt           DateTime  @default(now())
      updatedAt           DateTime  @updatedAt

      user User @relation(fields: [userId], references: [id], onDelete: Cascade)

      @@index([userId])
      @@index([polarSubscriptionId])
    }
    ```
  </Accordion>
</AccordionGroup>

---

## Common Queries

<Tabs>
  <Tab title="Create" icon="plus">
    ```typescript
    import { prisma } from "@repo/database";

    // Create a user
    const user = await prisma.user.create({
      data: {
        email: "user@example.com",
        name: "John Doe",
        password: hashedPassword,
      },
    });

    // Create with relation
    const session = await prisma.session.create({
      data: {
        token: sessionToken,
        userId: user.id,
        expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
      },
    });
    ```
  </Tab>
  <Tab title="Read" icon="magnifying-glass">
    ```typescript
    // Find by unique field
    const user = await prisma.user.findUnique({
      where: { email: "user@example.com" },
    });

    // Find with relations
    const userWithSessions = await prisma.user.findUnique({
      where: { id: userId },
      include: { sessions: true },
    });

    // Find many with filter
    const admins = await prisma.user.findMany({
      where: { role: "ADMIN" },
      orderBy: { createdAt: "desc" },
    });
    ```
  </Tab>
  <Tab title="Update" icon="pen">
    ```typescript
    // Update by ID
    const updated = await prisma.user.update({
      where: { id: userId },
      data: { name: "Jane Doe" },
    });

    // Update many
    await prisma.session.updateMany({
      where: { expiresAt: { lt: new Date() } },
      data: { /* mark as expired */ },
    });
    ```
  </Tab>
  <Tab title="Delete" icon="trash">
    ```typescript
    // Delete by ID
    await prisma.user.delete({
      where: { id: userId },
    });

    // Delete expired tokens
    await prisma.verificationToken.deleteMany({
      where: { expiresAt: { lt: new Date() } },
    });
    ```
  </Tab>
</Tabs>

---

## Database Commands

<CardGroup cols={2}>
  <Card title="Push Schema" icon="arrow-up">
    ```bash
    bun run db:push
    ```
    Push changes without migrations (dev)
  </Card>
  <Card title="Generate Client" icon="gear">
    ```bash
    bun run db:generate
    ```
    Regenerate Prisma client
  </Card>
  <Card title="Run Migrations" icon="database">
    ```bash
    bun run db:migrate
    ```
    Create and apply migrations
  </Card>
  <Card title="Open Studio" icon="table">
    ```bash
    bun run db:studio
    ```
    Visual database browser
  </Card>
</CardGroup>

---

## Adding New Models

<Steps>
  <Step title="Edit Schema">
    Add your model to `packages/database/prisma/schema.prisma`:

    ```prisma
    model Product {
      id          String   @id @default(cuid())
      name        String
      description String?
      price       Int
      createdAt   DateTime @default(now())
      updatedAt   DateTime @updatedAt
    }
    ```
  </Step>
  <Step title="Push or Migrate">
    ```bash
    # Development (quick sync)
    bun run db:push

    # Production (with migration history)
    bun run db:migrate
    ```
  </Step>
  <Step title="Use in Code">
    ```typescript
    import { prisma } from "@repo/database";

    const products = await prisma.product.findMany();
    ```
  </Step>
</Steps>

<Tip>
  Use `bun run db:studio` to visually explore and edit your database at
  [localhost:5555](http://localhost:5555).
</Tip>
````
